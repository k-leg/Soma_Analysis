)
loadings <- as.data.frame(plsda_result$loadings$X) %>%
rownames_to_column(var="Cell")
top10_loadings <- loadings %>%
mutate(abs_loading = abs(comp1)) %>%
arrange(desc(abs_loading)) %>%
dplyr::slice(1:9)
loadings_plot <- ggplot(top10_loadings, aes(x = reorder(Cell, comp1), y = comp1, fill = comp1 > 0)) +
geom_col(show.legend = FALSE) +
scale_fill_manual(values = c("indianred3", "steelblue")) +
coord_flip() +
labs(
title = "Top 10 PLS Loadings (C2)",
x = "Cell",
y = "Loading Value"
) +
theme_minimal(base_size = 15)
plsda_plot
View(df_v2)
df_v2 <- df %>%
filter(str_ends(Sample.ID, "-V02"))
df_v2 <- df %>%
filter(str_ends(SampleID, "-V02"))
library(mixOmics)
set.seed(123)
plsda_matrix <- df_v2 %>% dplyr::select((where(is.numeric)))
plsda_response <- df_v2$Group
# run the PLSDA
plsda_result <- splsda(plsda_matrix, plsda_response, ncomp = 3, keepX = c(10,10,10), scale = T) #z scores the data within the plsda
PLS_scores <- as.data.frame(plsda_result$variates$X)
PLS_scores$Response <- df_v2$Group
# plot the result
explained_var <- plsda_result$prop_expl_var$X
x_lab <- paste0("Component 1 (", round(explained_var[1] * 100, 1), "%)")
y_lab <- paste0("Component 2 (", round(explained_var[2] * 100, 1), "%)")
plsda_plot <- ggplot(PLS_scores, aes(x = comp1, y = comp2, color = Response, fill = Response)) +
geom_point(size = 3, alpha = 0.8) +
stat_ellipse(type = "norm", level = 0.85, geom = "polygon", alpha = 0.2, color = NA)+
scale_fill_discrete(guide = "none") +
theme_minimal(base_size = 14) +
labs(
title = "Infection vs Healed",
x = x_lab,
y = y_lab,
color = "Group",
) +
theme(
plot.title = element_text(hjust = 0.5),
legend.position = "right",
axis.text = element_text(size = 14)
)
loadings <- as.data.frame(plsda_result$loadings$X) %>%
rownames_to_column(var="Cell")
top10_loadings <- loadings %>%
mutate(abs_loading = abs(comp1)) %>%
arrange(desc(abs_loading)) %>%
dplyr::slice(1:9)
loadings_plot <- ggplot(top10_loadings, aes(x = reorder(Cell, comp1), y = comp1, fill = comp1 > 0)) +
geom_col(show.legend = FALSE) +
scale_fill_manual(values = c("indianred3", "steelblue")) +
coord_flip() +
labs(
title = "Top 10 PLS Loadings (C2)",
x = "Cell",
y = "Loading Value"
) +
theme_minimal(base_size = 15)
plsda_plot
loadings_plot
library("SomaDataIO")
master <- read_adat("~/Documents/R scripts/Soma_project/L0125004423_v5.0_EDTAPlasma.hybNorm.medNormInt.plateScale.calibrate.anmlQC.qcCheck.anmlSMP.20251008.adat")
head(master)
library(dplyr)
#remove calibrators and flagged samples
df <- master %>%
filter(
!SampleType %in% c("Calibrator", "Buffer", "QC"),
RowCheck != "FLAG"
) %>% as_tibble()
#remove unwanted columns
df <- df %>% dplyr::select(-PlateId,-PlateRunDate, -ScannerID, -PlatePosition, -SlideId, -Subarray,-PercentDilution,-SampleMatrix,-Barcode,-Barcode2d,-SampleNotes,-AliquotingNotes, -SampleDescription, -AssayNotes, -ExtIdentifier, -SsfExtId,-SampleGroup,-SubjectID, -CLI, -RMA, -HybControlNormScale,-NormScale_20, -NormScale_0_005, -NormScale_0_5, -ANMLFractionUsed_20, -ANMLFractionUsed_0_005, -ANMLFractionUsed_0_5,-SiteId,-TimePoint, -SampleName, -SampleType, -RowCheck)
rownames(df) = NULL
View(master)
library(stringr)
library(readr)
library(dplyr)
#load in the conversion key csv
map <- read.csv("seqid_to_uniprot.csv")
#reformatting (eg. 10023-32 to seq.10023.32)
map <- map %>% mutate(
seqid_formatted = paste0("seq.", gsub("-",".",SeqId))
)
# make the vector from the map df
id_map <- setNames(map$UniProtID, map$seqid_formatted)
# don't rename the seqID column
old_names <- colnames(df)
new_names <- old_names
new_names[-1] <- ifelse(
old_names[-1] %in% names(id_map),
id_map[old_names[-1]],
old_names[-1]
)
colnames(df) <- new_names
#remove any columns that still start with "seq" because these are controls
names(df) <- make.unique(names(df)) # some somamer sequences map to the same uniprotID but different regimes of the protein(cytoplasmic vs extracellular, etc. this makes the column names unique to avoid errors on dplyr.)
df <- df %>% dplyr::select(-starts_with("seq"))
View(df)
df <- df %>%
mutate(
Timepoint = str_extract(SampleId, "D[1-5]$"),       # extract D1–D5 at the end
SubjectID = str_remove(SampleId, "D[1-5]$")         # remove D1–D5 to get the subject ID
) %>%
relocate(SubjectID, .before = SampleId) %>%            # move SubjectID before SampleId
relocate(Timepoint, .after = SampleId)
df$Timepoint <- factor(df$Timepoint)
df <- as_tibble(df)
View(df)
df_log2 <- df %>% mutate(across(where(is.numeric), ~ log2(.x)))
library(tidyverse)
# Vector of target proteins
target_proteins <- c("P05231","P0DJI8","Q14116")
# Convert to long format for ggplot
df_long <- df %>%
pivot_longer(cols = all_of(target_proteins),
names_to = "Protein",
values_to = "Expression")
# Summary stats: mean and SE per group
summary_df <- df_long %>%
group_by(Protein, Timepoint) %>%
summarise(
mean_expr = mean(Expression, na.rm = TRUE),
sd_expr = sd(Expression, na.rm = TRUE),
.groups = "drop"
)
# Plot
plot1 <- ggplot(summary_df, aes(x = Timepoint, y = mean_expr, fill = Timepoint)) +
geom_col(position = "dodge", color = "black", width = 0.8) +
geom_errorbar(aes(ymin = mean_expr - sd_expr, ymax = mean_expr + sd_expr),
width = 0.2, position = position_dodge(0.7)) +
facet_wrap(~ Protein, scales = "free_y", ncol = 4) +
theme_minimal(base_size = 14) +
theme(
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
strip.text = element_text(face = "bold", size = 13, margin = margin(b=20)),
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"
) +
labs(
title = "",
x = "Draw",
y = "Mean Expression"
)
plot1
library(mixOmics)
set.seed(123)
plsda_matrix <- df_log2 %>% dplyr::select((where(is.numeric)))
plsda_response <- df_log2$Timepoint
# run the PLSDA
plsda_result <- splsda(plsda_matrix, plsda_response, ncomp = 3, keepX = c(75,75,75), scale = T) #z scores the data within the plsda
PLS_scores <- as.data.frame(plsda_result$variates$X)
PLS_scores$Response <- df_log2$Timepoint
# plot the result
explained_var <- plsda_result$prop_expl_var$X
x_lab <- paste0("Component 1 (", round(explained_var[1] * 100, 1), "%)")
y_lab <- paste0("Component 2 (", round(explained_var[2] * 100, 1), "%)")
plsda_plot <- ggplot(PLS_scores, aes(x = comp1, y = comp2, color = Response, fill = Response)) +
geom_point(size = 3, alpha = 0.8) +
stat_ellipse(type = "norm", level = 0.85, geom = "polygon", alpha = 0.2, color = NA)+
scale_fill_discrete(guide = "none") +
theme_minimal(base_size = 14) +
labs(
title = "Proteins over Time",
x = x_lab,
y = y_lab,
color = "Blood Draw Timepoint",
) +
theme(
plot.title = element_text(hjust = 0.5),
legend.position = "right",
axis.text = element_text(size = 14)
)
loadings <- as.data.frame(plsda_result$loadings$X) %>%
rownames_to_column(var="Protein")
top20_loadings <- loadings %>%
mutate(abs_loading = abs(comp1)) %>%
arrange(desc(abs_loading)) %>%
dplyr::slice(1:20)
loadings_plot <- ggplot(top20_loadings, aes(x = reorder(Protein, comp1), y = comp1, fill = comp1 > 0)) +
geom_col(show.legend = FALSE) +
scale_fill_manual(values = c("indianred3", "steelblue")) +
coord_flip() +
labs(
title = "Top 20 PLS Loadings (C2)",
x = "Protein",
y = "Loading Value"
) +
theme_minimal()
#dir.create("PLSDA_results", showWarnings = FALSE)
write_csv(loadings, "PLSDA_results/PLSDA_loadings.csv")
plsda_plot
library(dplyr)
cell_df <- read.csv("long_cells.csv", colClasses = c(SubjectID = "character"), header = TRUE)
cell_df$Timepoint <- factor(cell_df$Timepoint)
cell_df$monocytes <- as.numeric(cell_df$monocytes)
cell_df <- cell_df %>% mutate(across(where(is.numeric),
~ as.numeric(replace_na(.,mean(.,na.rm=T)))))
cell_df <- cell_df %>% mutate(across(where(is.numeric), ~as.numeric(.x/100)))
#
# cell_df <- cell_df %>%
#   mutate(across(where(is.numeric),
#                 ~ car::logit((.x ) + 1e-6, adjust = 1e-6)))
head(cell_df)
integrated_df <- full_join(cell_df,
df_log2,
by = c("SubjectID","SampleId","Timepoint"))
library(mixOmics)
set.seed(123)
plsda_matrix <- integrated_df %>% dplyr::select((where(is.numeric)))
plsda_matrix <- scale(plsda_matrix)
plsda_response <- integrated_df$Timepoint
# run the PLSDA
plsda_integ_result <- splsda(plsda_matrix, plsda_response, ncomp = 2, keepX = c(75,75))
PLS_scores <- as.data.frame(plsda_integ_result$variates$X)
PLS_scores$Response <- integrated_df$Timepoint
# plot the result
explained_var <- plsda_integ_result$prop_expl_var$X
x_lab <- paste0("Component 1 (", round(explained_var[1] * 100, 1), "%)")
y_lab <- paste0("Component 2 (", round(explained_var[2] * 100, 1), "%)")
plsda_plot <- ggplot(PLS_scores, aes(x = comp1, y = comp2, color = Response, fill = Response)) +
geom_point(size = 3, alpha = 0.8) +
stat_ellipse(type = "norm", level = 0.85, geom = "polygon", alpha = 0.2, color = NA)+
scale_fill_discrete(guide = "none") +
theme_minimal(base_size = 14) +
labs(
title = "PLSDA of cell and protein data",
x = x_lab,
y = y_lab,
color = "Blood Draw Timepoint",
) +
theme(
plot.title = element_text(hjust = 0.5),
legend.position = "right",
axis.text = element_text(size = 14)
)
integ_loadings <- as.data.frame(plsda_integ_result$loadings$X) %>%
rownames_to_column(var="Protein")
top20_loadings <- integ_loadings %>%
mutate(abs_loading = abs(comp1)) %>%
arrange(desc(abs_loading)) %>%
dplyr::slice(1:20)
loadings_plot <- ggplot(top20_loadings, aes(x = reorder(Protein, comp1), y = comp1, fill = comp1 > 0)) +
geom_col(show.legend = FALSE) +
scale_fill_manual(values = c("indianred3", "steelblue")) +
coord_flip() +
labs(
title = "Top 20 PLS Loadings (C2)",
x = "Protein",
y = "Loading Value"
) +
theme_minimal()
write_csv(integ_loadings, "PLSDA_integ_results/PLSDA_loadings.csv")
write_csv(integ_loadings, "PLSDA_results/PLSDA_integ_loadings.csv")
setwd("~/Documents/R scripts/Soma_project")
write_csv(integ_loadings, "PLSDA_results/PLSDA_integ_loadings.csv")
biocmanager::install("enrichplot")
BiocManager::install("enrichplot")
View(df_log2)
View(df_log2)
library(tidyverse)
fc_df <- df %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
names_from = Timepoint,
values_from = log2_expr
) %>%
filter(!is.na(D1) & !is.na(D2)) %>%   # ensure paired samples
mutate(log2_FC_D2_vs_D1 = D2 - D1) %>%
select(SubjectID, Protein, log2_FC_D2_vs_D1)
View(df)
library(tidyverse)
library(clusterProfiler)
library(enrichplot)
# compute log2foldchange of D1 vs D2 and D2 vs D3
library(tidyverse)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
names_from = Timepoint,
values_from = log2_expr
) %>%
filter(!is.na(D1) & !is.na(D2)) %>%   # ensure paired samples
mutate(log2_FC_D2_vs_D1 = D2 - D1) %>%
dplyr::select(SubjectID, Protein, log2_FC_D2_vs_D1)
View(fc_df)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2"))
View(fc_df)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
View(fc_df)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
)
View(fc_df)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
names_from = Timepoint,
values_from = log2_expr
)
View(fc_df)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
)
View(fc_df)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
names_from = Timepoint,
values_from = log2_expr
) %>%
)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
names_from = Timepoint,
values_from = log2_expr
)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
names_from = Timepoint,
values_from = log2_expr
) %>%
filter(!is.na(D1) & !is.na(D2)) %>%   # ensure paired samples
mutate(log2_FC_D2_vs_D1 = D2 - D1) %>%
dplyr::select(SubjectID, Protein, log2_FC_D2_vs_D1)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
names_from = Timepoint,
values_from = log2_expr
) %>%
filter(!is.na(D1) & !is.na(D2)) %>%   # ensure paired samples
mutate(log2_FC_D2_vs_D1 = D2 - D1) %>%
dplyr::select(SubjectID, Protein, log2_FC_D2_vs_D1)
View(fc_df)
fc_df <- df %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
id_cols    = c(SubjectID, Protein),
names_from = Timepoint,
values_from = log2_expr
) %>%
filter(!is.na(D1) & !is.na(D2)) %>%
mutate(log2_FC_D2_vs_D1 = D2 - D1)
View(fc_df)
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
id_cols    = c(SubjectID, Protein),
names_from = Timepoint,
values_from = log2_expr
) %>%
filter(!is.na(D1) & !is.na(D2)) %>%
mutate(log2_FC_D2_vs_D1 = D2 - D1)
View(fc_df)
ranks_df <- fc_df %>%
group_by(Protein) %>%
summarize(stat = mean(log2_FC_D2_vs_D1, na.rm = TRUE), .groups = "drop")
ranks <- ranks_df$stat
names(ranks) <- ranks_df$Protein
# fgsea expects a named numeric vector; sorting is recommended
ranks <- sort(ranks, decreasing = TRUE)
View(ranks_df)
ranks_df <- fc_df %>%
group_by(Protein) %>%
summarize(meanlog2fc = mean(log2_FC_D2_vs_D1, na.rm = TRUE), .groups = "drop")
ranks <- ranks_df$meanlog2fc
names(ranks) <- ranks_df$Protein
# fgsea expects a named numeric vector; sorting is recommended
ranks <- sort(ranks, decreasing = TRUE)
ranks_df <- fc_df %>%
group_by(Protein) %>%
summarize(meanlog2fc = mean(log2_FC_D2_vs_D1, na.rm = TRUE), .groups = "drop")
ranks <- ranks_df$meanlog2fc
ranks <- as.numeric(ranks)
names(ranks) <- ranks_df$Protein
# fgsea expects a named numeric vector; sorting is recommended
ranks <- sort(ranks, decreasing = TRUE)
ranks
fc_df <- df_log2 %>%
filter(Timepoint %in% c("D1", "D2")) %>%
pivot_longer(
cols = -c(SubjectID, SampleId, Timepoint),
names_to = "Protein",
values_to = "log2_expr"
) %>%
pivot_wider(
id_cols    = c(SubjectID, Protein),
names_from = Timepoint,
values_from = log2_expr
) %>%
filter(!is.na(D1) & !is.na(D2)) %>%
mutate(log2_FC_D2_vs_D1 = D2 - D1)
ranks_df <- fc_df %>%
group_by(Protein) %>%
summarize(meanlog2fc = mean(log2_FC_D2_vs_D1, na.rm = TRUE), .groups = "drop")
ranks_df <- ranks_df %>%
mutate(
UNIPROT_raw = Protein,
UNIPROT = str_replace(Protein, "\\.\\d+$", ""),   # removes trailing .<digits>
meanlog2fc = as.numeric(meanlog2fc)
)
View(ranks_df)
ranks_df <- ranks_df %>%
group_by(UNIPROT) %>%
slice_max(order_by = abs(meanlog2fc), n = 1, with_ties = FALSE) %>%
ungroup()
View(ranks_df)
library(org.Hs.eg.db)
library(AnnotationDbi)
map <- AnnotationDbi::select(
org.Hs.eg.db,
keys     = unique(ranks_df2$UNIPROT),
keytype  = "UNIPROT",
columns  = c("ENTREZID")
) %>%
filter(!is.na(ENTREZID)) %>%
distinct(UNIPROT, ENTREZID)
library(org.Hs.eg.db)
library(AnnotationDbi)
map <- AnnotationDbi::select(
org.Hs.eg.db,
keys     = unique(ranks_df$UNIPROT),
keytype  = "UNIPROT",
columns  = c("ENTREZID")
) %>%
filter(!is.na(ENTREZID)) %>%
distinct(UNIPROT, ENTREZID)
View(map)
ranks_entrez_df <- ranks_df %>%
inner_join(map, by = "UNIPROT") %>%
group_by(ENTREZID) %>%
slice_max(order_by = abs(meanlog2fc), n = 1, with_ties = FALSE) %>%
ungroup()
ranks_entrez <- ranks_entrez_df$meanlog2fc
names(ranks_entrez) <- ranks_entrez_df$ENTREZID
ranks_entrez <- sort(ranks_entrez, decreasing = TRUE)
View(ranks_entrez_df)
nrow(ranks_entrez_df)
anyDuplicated(names(ranks_entrez))
str(ranks_entrez)
